#!/bin/sh

. /lib/functions/uci-defaults.sh
. /lib/functions/bos-defaults.sh

if [ $BOS_MODE == 'recovery' ]; then
	DEFAULT_UENV_MTD=mtd4
	# try to find MTD partition for recovery U-Boot environment
	uboot_env_mtd=$(cat /proc/mtd | grep -w recovery_uboot_env | sed 's/^\([^:]*\).*/\1/')
	uboot_env_mtd=${uboot_env_mtd:-$DEFAULT_UENV_MTD}

	# update U-Boot environment configuration with recovery partition
	sed "s/$DEFAULT_UENV_MTD/$uboot_env_mtd/" /etc/fw_env.config >/tmp/fw_env.config
fi

hostname=$(bos_get_config "net_hostname")

if [ -z "$hostname" ]; then
	# use default hostname when it is missing
	macaddr="$(cat /sys/class/net/eth0/address)"
	minerid="$(echo $macaddr | sed 's/.*:\(.*\):\(.*\):\(.*\)/\1\2\3/')"
	hostname="miner-$minerid"
fi

board_config_update

ucidef_set_hostname "$hostname"
ucidef_set_log 1024 "/var/log/syslog"

board_config_flush

exit 0
